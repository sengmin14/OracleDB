# 🥕 옵티마이저(Optimizer)

## 옵타마이저란?

- 옵티마이저는 가장 효율적인 방법으로 SQL을 수행할 최적의 처리 경로를 생성해주는 DBMS의 핵심
- 컴퓨터 두뇌가 CPU라면, DBMS의 두뇌는 Optimizer이다.
- 개발자가 SQL을 작성하고 실행하면 소프트웨어 실행 파일처럼 즉시 실행되는 것이 아니라 옵티마이저(Optimizer)에서 "이 쿼리문을 어떻게 실행 시키겠다"라는 여러가지 실행 계획을 세움
- 이렇게 실행 계획을 세운 뒤 시스템 통계정보를 활용하여 각 실행 계획의 예상 비용을 산정한 후 각 실행 계획을 비교하여 최고의 효율을 가지고 있는 실행 계획을 판별한 후 그 실행 계획에 따라 수행하게 됨

<img width="456" height="343" alt="Image" src="https://github.com/user-attachments/assets/1d922de5-d0b1-440a-8e97-b33142ae27e6" />
<br>

## 옵티마이저 동작 방식

<img width="629" height="217" alt="Image" src="https://github.com/user-attachments/assets/ff976f1b-5952-4458-b54d-e362326da17d" />

```
✅ 옵티마이저의 SQL 최적화 과정(비용기반 옵티마이저 기준)
1. 사용자가 던진 쿼리수행을 위해, 후보군이 될만한 실행계획 검색
2. Data Dictionary에 미리 수집해 놓은 오브젝트 통계 및 시스템 통계정보를 이용해 각 실행계획의 예상비용 산정
3. 각 실행계획을 비교해서 최저비용을 갖는 하나를 선택
```

### 역할

- Parser : SQL 문장을 분석하여 문법 검사와 구성요소를 파악하고 이를 파싱하여 파싱 트리를 만듬
- Query Transformer : 파싱된 SQL을 보고 같은 결과를 도출하되 좀 더 나은 실행 계획을 갖는 SQL로 변환이 가능한지 판단하여 변환 작업을 수행
- Estimator : 시스템 통계 정보를 Dictionary로부터 수집하여 SQL을 실행할 때 소요되는 총 비용을 계산
- Plan Generator : Estimator를 통해 계산된 값들을 토대로 후보군이 되는 실행 계획을 도출
- Row-Source Generator : 옵티마이저가 생성한 실행 계획을 SQL 엔진이 실제 실행할 수 있는 코드나 프로시저 형태로 포맷팅 함
- SQL Engine : SQL을 실행

<br>

## 옵티마이저의 종류

- 옵티마이저는 규칙 기반 옵티마이저와 비용 기반 옵티마이저로 나뉨
<img width="1210" height="555" alt="Image" src="https://github.com/user-attachments/assets/abc9ec59-5b03-410f-a49e-7cde6fb07a9a" />


### 규칙 기반 옵티마이저(Rule Based Optimizer, RBO)
- Oracle 8 이하의 버전에서 기본으로 설정된 옵티마이저가 바로 규칙 기반 옵티마이저이다.
- 이 규칙 기반 옵티마이저는 말 그대로 실행 속도가 빠른 순으로 규칙을 먼저 세워두고 우선순위가 앞서는 방법을 채택하는 것이다.
- 과거에는 옵티마이저의 비용을 예측하는 능력이 좋지 않아 이러한 방식을 사용함
- 규칙 기반 옵티마이저는 우선 순위가 있기 때문에 옵티마이저에서 실행 계획이 세워지는 것을 미리 예측할 수 있다.
- 하지만, 테이블에 데이터가 몇 개 없을 경우 전체 조회 한다고 하면 FULL SCAN이 더 빠를 수 있는데 INDEX를 확인하고 조회하면 비효율적인 실행 계획이 도출될 수 있다.
- 옵티마이저의 실행 계획을 유도할 수 있는 힌트와 HASH JOIN의 경우 규칙 기반 이후에 나온 개념들이기에 RBO에선 사용할 수 없다.
- 우선순위는 아래 참고
<img width="1205" height="1100" alt="Image" src="https://github.com/user-attachments/assets/dbcbfa68-e351-4bee-bafd-3d75d262a697" />

### 비용 기반 옵티마이저(Cost Based Optimizer, CBO)
- Oracle 10 이후부터 공식적으로 비용 기반 옵티마이저를 사용하고 있음
- 비용 기반 옵티마이저는 옵티마이저에게 실행 계획을 세운 뒤(최대 2천개까지) 비용이 최소한으로 나온 실행 계획을 수행함
- 비용 기반 옵티마이저는 비용을 예측하기 위해서 테이블, 인덱스, 칼럼 등의 다양한 객체 통계 정보와 시스템 통계 정보를 이용
- 통계 정보가 없는 경우 비효율적인 실행 계획을 생성할 수 있기 때문에 정확한 통계 정보를 유지하는 것이 중요

#### 비용 기반 옵티마이저의 모드
- CHOOSE : SQL이 실행되는 환경에서 통계 정보를 가져올 수 있으면 비용 기반(CBO)으로 그렇지 않다면 규칙 기반(RBO)으로 작동시키는 모드
- FIRST_ROWS : 옵티마이저가 처리 결과 중 첫 건을 출력하는데 걸리는 시간을 최소화할 수 있는 실행 계획을 세우는 모드
- FIRST_ROWS_n : 지정한 N개의 행을 가장 빠르게 반환하도록 하는 모드
- ALL_ROWS : SQL 실행 결과 전체를 빠르게 처리하는데 최적화 된 실행 계획을 세우는 모드. 마지막으로 출력 될 행까지 최소한의 자원을 사용하여 최대한 빨리 가져오게 하며 Oracle 10g 이후, 이 모드가 기본 값으로 설정되어 있다.

